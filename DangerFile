#FILE HELPERS
gitfiles = (git.modified_files + git.added_files).uniq
has_code_changes = !gitfiles.grep(/^Source/).empty?
has_tests_changes = !gitfiles.grep(/^Tests/).empty?

build_reports = []
test_reports = []
Find.find("./output") do |path|
	build_reports << path if path =~ /.*\.build-report.json$/
	test_reports << path if path =~ /.*\.test-report.xml$/
end

def read_platform_from_file(path:)
    path.basename.to_s.split('.').first
end

def label_tests_summary(path:) 
	json = File.read(path.to_s)
	data = JSON.parse(json)
	data["tests_summary_messages"].each { |message| 
    	if !message.empty?
    	   message.insert(1, "_[" + read_platform_from_file(path: path) + "]_")
    	end
	}
	File.open(path.to_s,"w") do |f|
	   f.puts JSON.pretty_generate(data)
	end 
end

#BASIC CHECKS:
warn 'This PR is a WIP! ðŸ¦‘' if github.pr_title.include? '[WIP]'
warn 'Big PR, try to keep changes smaller if you can ðŸ˜œ' if git.lines_of_code > 500
fail 'This PR don\'t have a description ðŸ˜’' if github.pr_body.length < 5
fail 'This PR don\'t have any user assigned ðŸ˜™' if github.pr_json["assignees"].count == 0
fail 'This PR don\'t have any user reviewers ðŸ˜™' if github.pr_json["requested_reviewers"].count == 0

#BUILD PARSE:
build_reports.each do |path|
	path = Pathname(path)
    label_tests_summary(path: path)
	xcode_summary.report path.to_s
end

#JUNIT PARSE:
test_reports.each do |path|
	path = Pathname(path)
	junit.parse path.to_s
	junit.report

	all_test = junit.tests.map(&:attributes)
	slowest_test = all_test.sort_by { |attributes| attributes[:time].to_f }.last
	message "_[#{read_platform_from_file(path: path)}]_ Slowest test: #{slowest_test[:name]} took #{'%.3f' % slowest_test[:time]} seconds"
end

#SWIFTLINT
swiftlint.lint_all_files = true
swiftlint.lint_files fail_on_error: true

#TEST EVOLUTION CHECK:
if has_code_changes 
	warn('You have changes in code but there is no changes in any test... do you sleep well at night? ðŸ¤¨') if !has_tests_changes
end